const path=require('path');
const bcrypt=require('bcrypt');

const express=require('express');
const app=express();

const userDetails=require(path.join('..','Model','userDetails.model.js'));
const documentCheck=userDetails.register;


function LoginRouterGetFunction(req,res){
    res.sendFile(path.join(__dirname,'..','Client','public','Login_page.html'));
}

function LoginRouterPostFunction(req,res){
    const signInName=req.body.username;
    const signInPassword=req.body.user_password;
    const signInRadio=req.body.privilege;
    documentCheck.find({autoGeneratedUserName:signInName},(error,data)=>{
        if(error){
            console.log(error);
        }
        else{
            if(data.length==0){
                console.log(data);
                res.status(400).json({
                    error:'user not found'
            });
            }
            else{
                for(let i=0;i<data.length;i++){
                bcrypt.compare(signInPassword,data[i].userPassword,(error,foundUser)=>{
                    if(foundUser){
                        const userId=data[i]._id;
                       if(signInRadio=='User'){
                        req.session.Login=true;
                        req.session.userIdentification=userId;
                        res.redirect('/Userdashboard');
                       }
                       else if(signInRadio=='Admin'){
                        // i'm not done with the admin login authentication, this very block
                        req.session.Login=true;
                        req.session.userIdentification=userId;
                          res.redirect('/Admin')
                       }
                    }
                    else{
                        res.status(400).json({
                            error:'wrong username or password'
                        });
                    }
                });
                }
            }
        }
    })
}

    
module.exports={
    LoginRouterGetFunction,
    LoginRouterPostFunction
}
